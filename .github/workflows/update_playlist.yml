name: Update Domestic IPTV
on:
  workflow_dispatch:  # 手动触发开关
  schedule:
    - cron: '0 0 * * *'  # 每天凌晨自动更新

jobs:
  build:
    runs-on: ubuntu-latest
    permissions: write-all  # 赋予提交代码的权限
    steps:
      # 第一步：拉取仓库代码
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 第二步：安装依赖工具（python3等）
      - name: Install Required Tools
        run: |
          sudo apt update -y
          sudo apt install -y python3 python3-pip curl dos2unix

      # 第三步：执行生成脚本，生成IPTV列表
      - name: Generate IPTV Playlist
        run: |
          python3 make_playlist.py
          # 验证生成结果
          if [ -f "playlist.m3u8" ]; then
            echo "✅ IPTV列表生成成功，文件大小：$(du -h playlist.m3u8 | awk '{print $1}')"
            # 显示前5行内容，确认格式正确
            head -5 playlist.m3u8
          else
            echo "❌ IPTV列表生成失败"
            exit 1
          fi

      # 第四步：提交生成的列表到仓库
      - name: Push Playlist to Repository
        run: |
          git config --global user.name "IPTV-Bot"
          git config --global user.email "iptv-bot@example.com"
          # 添加生成的文件
          git add playlist.m3u8
          # 提交（无更新时不报错）
          git commit -m "Auto update domestic IPTV playlist: $(date +%Y-%m-%d %H:%M:%S)" || echo "✅ 无更新内容，无需提交"
          # 推送更新
          git push origin main -f
